<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clima Agora</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="logo">CLIMA<span>+</span></div>
  </header>

  <main class="dashboard">
    <div class="clima-row">
      <div class="weather-card">
        <div class="weather-info">
          <div class="weather-item">
            <h2>Bebedouro, SP</h2>
            <p>üå§ Sol com muitas nuvens</p>
          </div>
          <div class="weather-item">
            <h1>--¬∞</h1>
          </div>
          <div class="weather-item details">
            <p>√öltima leitura do sistema</p>
          </div>
        </div>
      </div>
    </div>

    <div class="graficos-row">
      <div class="chart-card">
        <h3>Probabilidade de Chuva (%)</h3>
        <canvas id="graficoChuva"></canvas>
      </div>
      <div class="chart-card">
        <h3>Temperatura (¬∞C)</h3>
        <canvas id="graficoTemperatura"></canvas>
      </div>
      <div class="chart-card">
        <h3>Press√£o Atmosf√©rica (hPa)</h3>
        <canvas id="graficoPressao"></canvas>
      </div>
    </div>

    <section class="about-project">
      <h3>Sobre o Projeto</h3>
      <p>
        O <strong>Clima+</strong> foi desenvolvido pela Escola SESI CE 110, pelos alunos do 3¬∫ ano do Ensino M√©dio, com o objetivo de fornecer informa√ß√µes sobre <strong>probabilidade de chuva</strong>, <strong>press√£o</strong> e <strong>temperatura</strong> de forma clara e acess√≠vel para a comunidade.
      </p>
    </section>
  </main>

  <script>
    const SUPABASE_URL = "https://unmnfifouemowyrkdjdj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVubW5maWZvdWVtb3d5cmtkamRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjI4MDcsImV4cCI6MjA3Mjk5ODgwN30.AZAm7yidblij9Wqm-wRbM8qUmFSq8YoWSrlHiJSKDu8";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function carregarClima() {
      try {
        const { data, error } = await supabase
          .from("sensores")
          .select("*")
          .order("id_sensores", { ascending: false })
          .limit(5);

        if (error) {
          console.error("Erro Supabase:", error);
          return;
        }

        if (!data || data.length === 0) {
          console.log("Nenhum dado dispon√≠vel na tabela.");
          return;
        }

        const ultimoClima = data[0];

        // Atualiza temperatura principal
        const tempEl = document.querySelector(".weather-item h1");
        if (tempEl) tempEl.textContent = (ultimoClima.temperatura ?? "--") + "¬∞";

        // Atualiza detalhes
        const detailsEl = document.querySelector(".weather-item.details");
        if (detailsEl) {
          detailsEl.innerHTML = `
            <p>√öltima leitura do sistema</p>
            <p>Press√£o: <span>${ultimoClima.pressao ?? "--"} hPa</span></p>
          `;
        }

        // Atualiza gr√°ficos
        atualizarGraficos(data.reverse());
      } catch (err) {
        console.error("Erro ao carregar clima:", err);
      }
    }

    function atualizarGraficos(dados) {
      const labels = dados.map((_, i) => `#${i + 1}`);

      // Converte valores de chuva: 4095 = 0%, 0 = 100%
      const chuva = dados.map(d => {
        const valor = d.chuva ?? 0;
        return Math.round(((4095 - valor) / 4095) * 100);
      });

      const temp = dados.map(d => d.temperatura ?? 0);
      const pressao = dados.map(d => d.pressao ?? 0);

      // Gr√°fico de chuva
      const ctxChuva = document.getElementById("graficoChuva");
      if (ctxChuva) {
        new Chart(ctxChuva, {
          type: "line",
          data: {
            labels,
            datasets: [{ label: "Chuva (%)", data: chuva, backgroundColor: "#4a90e2" }],
          },
          options: {
            scales: {
              y: { beginAtZero: true, max: 100 }
            }
          }
        });
      }

      // Gr√°fico de temperatura
      const ctxTemp = document.getElementById("graficoTemperatura");
      if (ctxTemp) {
        new Chart(ctxTemp, {
          type: "line",
          data: {
            labels,
            datasets: [{ label: "Temperatura (¬∞C)", data: temp, borderColor: "#ff5733", fill: false }],
          },
        });
      }

      // Gr√°fico de press√£o
      const ctxPressao = document.getElementById("graficoPressao");
      if (ctxPressao) {
        new Chart(ctxPressao, {
          type: "line",
          data: {
            labels,
            datasets: [{ label: "Press√£o (hPa)", data: pressao, borderColor: "#33c1ff", fill: false }],
          },
        });
      }
    }

    // Carrega ao abrir a p√°gina
    carregarClima();
    // Atualiza a cada 60s
    setInterval(carregarClima, 60000);
  </script>
</body>
</html>
